<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¤šæ¨¡æ€æ–‡ä»¶æè¿°ç¼–è¾‘å™¨</title>
<style>
:root { --bg: #1a1a2e; --bg-light: #16213e; --border: #0f3460; --text: #e0e0e0; --accent: #e94560; --text-dim: #888; --success-bg: #2d6a4f; --success-text: #b7e4c7; --error-bg: #6c3a3a; --error-text: #e0a0a0; }
[data-theme="light"] { --bg: #f5f5f5; --bg-light: #ffffff; --border: #ddd; --text: #333; --accent: #e94560; --text-dim: #666; --success-bg: #d4edda; --success-text: #155724; --error-bg: #f8d7da; --error-text: #721c24; }
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }
.header { background: var(--bg-light); padding: 12px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; }
.header h1 { font-size: 16px; color: var(--accent); }
.header .subtitle { font-size: 12px; color: var(--text-dim); }
.main { display: flex; flex: 1; overflow: hidden; }
.sidebar { width: 280px; background: var(--bg-light); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
.sidebar-header { padding: 10px 12px; border-bottom: 1px solid var(--border); font-size: 13px; font-weight: 600; color: var(--accent); }
.diary-list, .file-list { flex: 1; overflow-y: auto; }
.diary-item, .file-item { padding: 8px 12px; cursor: pointer; font-size: 13px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 8px; }
.diary-item:hover, .file-item:hover { background: var(--border); }
.diary-item.active, .file-item.active { background: color-mix(in srgb, var(--accent) 15%, transparent); border-left: 3px solid var(--accent); }
.file-icon { font-size: 16px; flex-shrink: 0; }
.file-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.file-status { font-size: 10px; padding: 2px 6px; border-radius: 3px; flex-shrink: 0; }
.file-status.has-desc { background: var(--success-bg); color: var(--success-text); }
.file-status.no-desc { background: var(--error-bg); color: var(--error-text); }
.editor-panel { flex: 1; display: flex; flex-direction: column; padding: 16px; gap: 12px; overflow-y: auto; }
.preview-area { text-align: center; padding: 16px; background: var(--bg-light); border-radius: 8px; min-height: 200px; display: flex; align-items: center; justify-content: center; }
.preview-area img { max-width: 100%; max-height: 300px; border-radius: 4px; }
.preview-placeholder { color: var(--text-dim); font-size: 14px; }
.form-group { display: flex; flex-direction: column; gap: 4px; }
.form-group label { font-size: 12px; color: var(--text-dim); font-weight: 600; }
.form-group input, .form-group textarea, .form-group select { background: var(--bg-light); border: 1px solid var(--border); color: var(--text); padding: 8px 10px; border-radius: 4px; font-size: 13px; font-family: inherit; }
.form-group textarea { resize: vertical; min-height: 120px; }
.form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: var(--accent); }
.btn-row { display: flex; gap: 8px; flex-wrap: wrap; }
.btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 500; transition: opacity 0.2s; }
.btn:hover { opacity: 0.85; }
.btn:disabled { opacity: 0.4; cursor: not-allowed; }
.btn-primary { background: var(--accent); color: white; }
.btn-secondary { background: var(--border); color: var(--text); }
.btn-danger { background: var(--error-bg); color: var(--error-text); }
.toast { position: fixed; bottom: 20px; right: 20px; padding: 10px 20px; border-radius: 6px; font-size: 13px; z-index: 999; animation: fadeIn 0.3s; }
.toast.success { background: var(--success-bg); color: var(--success-text); }
.toast.error { background: var(--error-bg); color: var(--error-text); }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.empty-state { display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-dim); font-size: 14px; }
.loading { color: var(--text-dim); font-size: 13px; padding: 12px; text-align: center; }
</style>
</head>
<body>
<div class="header">
  <h1>ğŸ“¸ å¤šæ¨¡æ€æ–‡ä»¶æè¿°ç¼–è¾‘å™¨</h1>
  <span class="subtitle">KnowledgeMediaDescriber v1.0</span>
</div>
<div class="main">
  <div class="sidebar">
    <div class="sidebar-header">ğŸ“ æ—¥è®°æœ¬ç›®å½•</div>
    <div class="diary-list" id="diaryList"><div class="loading">åŠ è½½ä¸­...</div></div>
    <div class="sidebar-header">ğŸ“„ æ–‡ä»¶åˆ—è¡¨</div>
    <div class="file-list" id="fileList"><div class="empty-state">è¯·é€‰æ‹©æ—¥è®°æœ¬</div></div>
  </div>
  <div class="editor-panel" id="editorPanel">
    <div class="empty-state" id="emptyState">è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªå¤šæ¨¡æ€æ–‡ä»¶è¿›è¡Œç¼–è¾‘</div>
    <div id="editorContent" style="display:none;">
      <div class="preview-area" id="previewArea">
        <span class="preview-placeholder">é¢„è§ˆåŒºåŸŸ</span>
      </div>
      <div class="form-group">
        <label>å½“å‰ç¼–è¾‘æ®µè½ (é¢„è®¾)</label>
        <div style="display: flex; gap: 8px;">
          <select id="presetSelect" style="flex: 1;" onchange="onPresetChange()">
            <option value="@All">@All (å…¨è§ˆ)</option>
            <option value="@Native">@Native (åŸç”Ÿ)</option>
            <option value="@Manual">@Manual (æ‰‹åŠ¨)</option>
          </select>
          <button class="btn btn-secondary" onclick="addNewPresetSegment()" title="æ·»åŠ æ–°é¢„è®¾æ®µè½">+</button>
        </div>
      </div>
      <div class="form-group">
        <label id="descLabel">æè¿°ä¿¡æ¯</label>
        <textarea id="descText" placeholder="è¾“å…¥æ–‡ä»¶æè¿°..."></textarea>
      </div>
      <div class="form-group">
        <label>æ ‡ç­¾ (Tag)</label>
        <input type="text" id="tagsInput" placeholder="tag1, tag2, tag3">
      </div>
      <div class="btn-row">
        <button class="btn btn-primary" id="btnSave" onclick="saveDescription()">ğŸ’¾ ä¿å­˜</button>
        <button class="btn btn-secondary" id="btnRecognize" onclick="triggerRecognize()">ğŸ¤– AI è¯†åˆ«</button>
        <button class="btn btn-secondary" id="btnRecognizeForce" onclick="triggerRecognize(true)">ğŸ”„ å¼ºåˆ¶é‡æ–°è¯†åˆ«</button>
        <button class="btn btn-danger" id="btnClear" onclick="clearDescription()">ğŸ—‘ï¸ æ¸…é™¤æè¿°</button>
      </div>
    </div>
  </div>
</div>
<script>
// ä¸»é¢˜åŒæ­¥ï¼šç›‘å¬çˆ¶çª—å£ä¸»é¢˜å˜åŒ–
window.addEventListener('message', (event) => {
  if (event.data && event.data.type === 'themeChange') {
    document.documentElement.setAttribute('data-theme', event.data.theme);
  }
});
window.addEventListener('DOMContentLoaded', () => {
  if (window.parent && window.parent !== window) {
    window.parent.postMessage({ type: 'requestTheme' }, '*');
  }
});

const API_BASE = '/admin_api/media-describer';
let currentDiary = null;
let currentFile = null;
let currentFullDescription = '';
let segmentsMap = new Map();

async function api(method, path, body) {
  const opts = { method, headers: { 'Content-Type': 'application/json' } };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(API_BASE + path, opts);
  return res.json();
}

function toast(msg, type = 'success') {
  const el = document.createElement('div');
  el.className = 'toast ' + type;
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

function getFileIcon(type) {
  const icons = { image: 'ğŸ–¼ï¸', video: 'ğŸ¬', audio: 'ğŸµ', pdf: 'ğŸ“„', text: 'ğŸ“', unknown: 'ğŸ“' };
  return icons[type] || 'ğŸ“';
}

async function loadDiaries() {
  const data = await api('GET', '/diaries');
  const el = document.getElementById('diaryList');
  if (!data.success || !data.diaries.length) { el.innerHTML = '<div class="empty-state">æ— æ—¥è®°æœ¬ç›®å½•</div>'; return; }
  el.innerHTML = data.diaries.map(d =>
    `<div class="diary-item" onclick="selectDiary('${d}')" data-name="${d}">ğŸ“ ${d}</div>`
  ).join('');
}

async function selectDiary(name) {
  currentDiary = name;
  currentFile = null;
  document.querySelectorAll('.diary-item').forEach(el => el.classList.toggle('active', el.dataset.name === name));
  document.getElementById('fileList').innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
  hideEditor();

  const data = await api('GET', '/files/' + encodeURIComponent(name));
  const el = document.getElementById('fileList');
  if (!data.success || !data.files.length) { el.innerHTML = '<div class="empty-state">æ— æ–‡ä»¶</div>'; return; }

  el.innerHTML = data.files.map(f => {
    const statusClass = f.type === 'text' ? '' : (f.hasDescription ? 'has-desc' : 'no-desc');
    const statusText = f.type === 'text' ? '' : (f.hasDescription ? 'å·²æè¿°' : 'æœªæè¿°');
    return `<div class="file-item" onclick="selectFile('${f.name}')" data-name="${f.name}">
      <span class="file-icon">${getFileIcon(f.type)}</span>
      <span class="file-name">${f.name}</span>
      ${statusText ? `<span class="file-status ${statusClass}">${statusText}</span>` : ''}
    </div>`;
  }).join('');
}

async function selectFile(name) {
  currentFile = name;
  document.querySelectorAll('.file-item').forEach(el => el.classList.toggle('active', el.dataset.name === name));

  const ext = name.split('.').pop().toLowerCase();
  const isText = ['txt', 'md'].includes(ext);
  if (isText) { hideEditor(); toast('æ–‡æœ¬æ–‡ä»¶æ— éœ€æè¿°ä¿¡æ¯', 'error'); return; }

  showEditor();
  await loadPresets();
  await loadPreview();
  await loadDescription();
}

async function loadPresets() {
  const data = await api('GET', '/presets');
  const sel = document.getElementById('presetSelect');
  const currentVal = sel.value;
  
  // 1. å®šä¹‰åŸºç¡€å›ºå®šé€‰é¡¹
  const options = [
    { value: '@All', text: '@All (å…¨è§ˆ)' },
    { value: '@Native', text: '@Native (åŸç”Ÿ)' },
    { value: '@Manual', text: '@Manual (æ‰‹åŠ¨)' }
  ];
  
  // 2. æ·»åŠ æ¥è‡ªæœåŠ¡å™¨çš„é¢„è®¾
  if (data.success && data.presets) {
    data.presets.forEach(p => {
      // è¿‡æ»¤æ‰å·²ç»ä½œä¸ºå›ºå®šé€‰é¡¹å­˜åœ¨çš„åç§°
      if (p !== 'Native' && p !== 'Manual' && p !== 'All') {
        options.push({ value: p, text: p });
      }
    });
  }
  
  // 3. æ·»åŠ æ¥è‡ªå½“å‰æ–‡ä»¶æè¿°ä¸­å·²å­˜åœ¨çš„æ®µè½ï¼ˆå¦‚æœä¸åœ¨åˆ—è¡¨ä¸­ï¼‰
  for (const pName of segmentsMap.keys()) {
    if (!options.some(o => o.value === pName || o.value === '@' + pName)) {
        options.push({ value: pName, text: pName });
    }
  }

  // æ¸²æŸ“ HTML
  sel.innerHTML = options.map(o => `<option value="${o.value}">${o.text}</option>`).join('');
  
  // æ¢å¤ä¹‹å‰çš„é€‰ä¸­é¡¹
  if ([...sel.options].some(o => o.value === currentVal)) {
    sel.value = currentVal;
  }
}

function parseSegments(fullDesc) {
    const map = new Map();
    if (!fullDesc) return map;

    const regex = /\[@([^\]]+):\]([\s\S]*?)(?=\[@[^\]]+:\]|$)/g;
    let match;
    let hasMatches = false;

    while ((match = regex.exec(fullDesc)) !== null) {
        hasMatches = true;
        const presetName = match[1].trim();
        const content = match[2].trim();
        if (content) {
            map.set(presetName, content);
        }
    }

    if (!hasMatches && fullDesc.trim()) {
        map.set('Native', fullDesc.trim());
    }

    return map;
}

function onPresetChange() {
    const sel = document.getElementById('presetSelect');
    const val = sel.value;
    const textarea = document.getElementById('descText');
    const label = document.getElementById('descLabel');

    if (val === '@All') {
        textarea.value = currentFullDescription;
        textarea.readOnly = false;
        label.textContent = 'å®Œæ•´æè¿°å†…å®¹ (åŒ…å«æ ‡è®°)';
    } else {
        const pName = val.startsWith('@') ? val.substring(1) : val;
        textarea.value = segmentsMap.get(pName) || '';
        textarea.readOnly = false;
        label.textContent = `æè¿°ä¿¡æ¯ [${val}]`;
    }
}

function addNewPresetSegment() {
    const name = prompt('è¯·è¾“å…¥æ–°é¢„è®¾æ®µè½åç§°:');
    if (!name) return;
    const sel = document.getElementById('presetSelect');
    const option = document.createElement('option');
    option.value = name;
    option.textContent = name;
    sel.appendChild(option);
    sel.value = name;
    onPresetChange();
}

async function loadPreview() {
  const area = document.getElementById('previewArea');
  const ext = currentFile.split('.').pop().toLowerCase();
  if (['png','jpg','jpeg','gif','webp','bmp','svg'].includes(ext)) {
    area.innerHTML = `<img src="${API_BASE}/thumbnail/${encodeURIComponent(currentDiary)}/${encodeURIComponent(currentFile)}" alt="${currentFile}">`;
  } else {
    area.innerHTML = `<span class="preview-placeholder">${getFileIcon(getFileType(ext))} ${currentFile}</span>`;
  }
}

function getFileType(ext) {
  if (['png','jpg','jpeg','gif','webp','bmp','svg','ico','tiff','tif','avif'].includes(ext)) return 'image';
  if (['mp4','avi','mov','mkv','webm','flv'].includes(ext)) return 'video';
  if (['mp3','wav','ogg','flac','aac','m4a'].includes(ext)) return 'audio';
  if (ext === 'pdf') return 'pdf';
  return 'unknown';
}

async function loadDescription() {
  const data = await api('GET', `/desc/${encodeURIComponent(currentDiary)}/${encodeURIComponent(currentFile)}`);
  const sel = document.getElementById('presetSelect');
  
  if (data.success && data.description) {
    currentFullDescription = data.description.description || '';
    segmentsMap = parseSegments(currentFullDescription);
    document.getElementById('tagsInput').value = data.description.tags || '';
    
    // å¦‚æœå½“å‰é€‰ä¸­çš„æ˜¯ @All ä¹‹å¤–çš„ï¼Œä¸”è¯¥æ®µè½æ²¡å†…å®¹ï¼Œå°è¯•åˆ‡åˆ°æœ‰å†…å®¹çš„ç¬¬ä¸€ä¸ªæ®µè½
    if (sel.value === '@All') {
        // ä¿æŒ @All
    } else {
        const pName = sel.value.startsWith('@') ? sel.value.substring(1) : sel.value;
        if (!segmentsMap.has(pName)) {
            // å°è¯•å¯»æ‰¾ç¬¬ä¸€ä¸ªæœ‰å†…å®¹çš„æ®µè½
            for (const [k, v] of segmentsMap) {
                sel.value = k === 'Native' ? '@Native' : (k === 'Manual' ? '@Manual' : k);
                break;
            }
        }
    }
  } else {
    currentFullDescription = '';
    segmentsMap = new Map();
    document.getElementById('tagsInput').value = '';
    sel.value = '@Manual';
  }
  
  await loadPresets(); // åˆ·æ–°ä¸‹æ‹‰åˆ—è¡¨ä»¥åŒ…å« desc ä¸­å­˜åœ¨çš„è‡ªå®šä¹‰æ®µè½
  onPresetChange();
}

async function saveDescription() {
  if (!currentDiary || !currentFile) return;
  const sel = document.getElementById('presetSelect');
  const val = sel.value;
  const content = document.getElementById('descText').value;
  
  let body = {
    tags: document.getElementById('tagsInput').value
  };

  if (val === '@All') {
      body.fullDescription = content;
  } else {
      body.updatePreset = val.startsWith('@') ? val.substring(1) : val;
      body.presetContent = content;
  }

  const data = await api('PUT', `/desc/${encodeURIComponent(currentDiary)}/${encodeURIComponent(currentFile)}`, body);
  if (data.success) {
    toast('ä¿å­˜æˆåŠŸ');
    await loadDescription(); // é‡æ–°åŠ è½½ä»¥æ›´æ–°å†…éƒ¨çŠ¶æ€
    selectDiary(currentDiary); // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨çŠ¶æ€
  } else {
    toast('ä¿å­˜å¤±è´¥: ' + data.error, 'error');
  }
}

async function triggerRecognize(force = false) {
  if (!currentDiary || !currentFile) return;
  let preset = document.getElementById('presetSelect').value;
  if (preset.startsWith('@')) preset = preset.substring(1);
  if (preset === 'All') preset = 'PresetDefault';

  const btn = force ? document.getElementById('btnRecognizeForce') : document.getElementById('btnRecognize');
  btn.disabled = true;
  btn.textContent = 'è¯†åˆ«ä¸­...';
  try {
    const data = await api('POST', `/recognize/${encodeURIComponent(currentDiary)}/${encodeURIComponent(currentFile)}?preset=${preset}&force=${force}`);
    if (data.success && data.description) {
      toast('AI è¯†åˆ«å®Œæˆ');
      await loadDescription();
      selectDiary(currentDiary);
    } else {
      toast('è¯†åˆ«å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
    }
  } catch (e) {
    toast('è¯†åˆ«è¯·æ±‚å¤±è´¥: ' + e.message, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = force ? 'ğŸ”„ å¼ºåˆ¶é‡æ–°è¯†åˆ«' : 'ğŸ¤– AI è¯†åˆ«';
  }
}

async function clearDescription() {
  if (!currentDiary || !currentFile) return;
  if (!confirm('ç¡®å®šè¦æ¸…é™¤è¯¥æ–‡ä»¶çš„æè¿°ä¿¡æ¯å—ï¼Ÿ')) return;
  const body = { presetName: '', description: '', tags: '' };
  const data = await api('PUT', `/desc/${encodeURIComponent(currentDiary)}/${encodeURIComponent(currentFile)}`, body);
  if (data.success) {
    document.getElementById('descText').value = '';
    document.getElementById('tagsInput').value = '';
    toast('æè¿°å·²æ¸…é™¤');
    selectDiary(currentDiary);
  }
}

function showEditor() {
  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('editorContent').style.display = 'block';
}
function hideEditor() {
  document.getElementById('emptyState').style.display = 'flex';
  document.getElementById('editorContent').style.display = 'none';
}

loadDiaries();
</script>
</body>
</html>